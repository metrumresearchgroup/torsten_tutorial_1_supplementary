<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-03-22 Thu 00:01 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Torsten: A Pharmacokinetic/Pharmacodynamic Model Library for Stan</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Yi Zhang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Torsten: A Pharmacokinetic/Pharmacodynamic Model Library for Stan
<br />
<span class="subtitle">User Manual  <br> (Torsten Version 0.84, Stan version 2.17.1)</span>
</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org2290cf5">Development team</a>
<ul>
<li><a href="#org464873c">Bill Gillespie</a></li>
<li><a href="#orgbf0d51d">Yi Zhang</a></li>
<li><a href="#orgdb12707">Charles Margossian</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf0d8355">Acknowledgements</a>
<ul>
<li><a href="#org0de153a">Institutions</a></li>
<li><a href="#org153c11d">Funding</a>
<ul>
<li><a href="#org6dbe26b">Office of Naval Research (ONR) contract N00014-16-P-2039</a></li>
<li><a href="#orgd4cb67f">Bill &amp; Melinda Gates Foundation.</a></li>
</ul>
</li>
<li><a href="#orgd5d682f">Individuals</a></li>
</ul>
</li>
<li><a href="#orgf3aa5e7">1. Introduction</a>
<ul>
<li><a href="#org6bffbf7">1.1. Installing Torsten</a>
<ul>
<li><a href="#org1c075bb">1.1.1. Command line version</a></li>
<li><a href="#org4234252">1.1.2. R version</a></li>
</ul>
</li>
<li><a href="#org5a0818b">1.2. Overview</a></li>
<li><a href="#orgd3ee97f">1.3. Implementation details</a></li>
<li><a href="#orge6ae963">1.4. Development plans</a></li>
<li><a href="#org1f7c8e5">1.5. Updates since Torsten 0.83</a></li>
</ul>
</li>
<li><a href="#org1b50fb3">2. Using Torsten</a>
<ul>
<li>
<ul>
<li><a href="#2cptmodel">Two compartment model</a></li>
</ul>
</li>
<li><a href="#orgea67120">2.1. One Compartment Model</a></li>
<li><a href="#org5910d51">2.2. Two Compartment Model</a></li>
<li><a href="#org97029f9">2.3. General Linear ODE Model Function</a></li>
<li><a href="#orga4be51d">2.4. General ODE Model Function</a></li>
<li><a href="#org610cb1f">2.5. Mixed ODE Model Function</a></li>
<li><a href="#org38c3417">2.6. Friberg-Karlsson Semi-Mechanistic Model</a>
<ul>
<li><a href="#fkmodel">Friberg-Karlsson Model</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org2290cf5" class="outline-3">
<h3 id="org2290cf5">Development team</h3>
<div class="outline-text-3" id="text-org2290cf5">
</div>
<div id="outline-container-org464873c" class="outline-4">
<h4 id="org464873c">Bill Gillespie</h4>
<div class="outline-text-4" id="text-org464873c">
<p>
<a href="mailto:billg@metrumrg.com"><code>billg@metrumrg.com</code></a>,
Metrum Research Group, LLC
</p>
</div>
</div>
<div id="outline-container-orgbf0d51d" class="outline-4">
<h4 id="orgbf0d51d">Yi Zhang</h4>
<div class="outline-text-4" id="text-orgbf0d51d">
<p>
<a href="mailto:yiz@metrumrg.com"><code>yiz@metrumrg.com</code></a>, Metrum Research Group, LLC
</p>
</div>
</div>
<div id="outline-container-orgdb12707" class="outline-4">
<h4 id="orgdb12707">Charles Margossian</h4>
<div class="outline-text-4" id="text-orgdb12707">
<p>
<a href="mailto:charles.margossian@columbia.edu"><code>charles.margossian@columbia.edu</code></a>, Columbia University, Department of Statistics(formerly Metrum Research Group, LLC)
</p>
</div>
</div>
</div>

<div id="outline-container-orgf0d8355" class="outline-2">
<h2 id="orgf0d8355">Acknowledgements</h2>
<div class="outline-text-2" id="text-orgf0d8355">
</div>
<div id="outline-container-org0de153a" class="outline-3">
<h3 id="org0de153a">Institutions</h3>
<div class="outline-text-3" id="text-org0de153a">
<p>
We thank Metrum Research Group, Columbia University, and AstraZeneca.
</p>
</div>
</div>
<div id="outline-container-org153c11d" class="outline-3">
<h3 id="org153c11d">Funding</h3>
<div class="outline-text-3" id="text-org153c11d">
<p>
This work was funded in part by the following organizations:
</p>
</div>
<div id="outline-container-org6dbe26b" class="outline-4">
<h4 id="org6dbe26b">Office of Naval Research (ONR) contract N00014-16-P-2039</h4>
<div class="outline-text-4" id="text-org6dbe26b">
<p>
provided as part of the Small Business Technology Transfer (STTR)
program. The content of the information presented in this document
does not necessarily reflect the position or policy of the
Government and no official endorsement should be inferred.
</p>
</div>
</div>
<div id="outline-container-orgd4cb67f" class="outline-4">
<h4 id="orgd4cb67f">Bill &amp; Melinda Gates Foundation.</h4>
</div>
</div>
<div id="outline-container-orgd5d682f" class="outline-3">
<h3 id="orgd5d682f">Individuals</h3>
<div class="outline-text-3" id="text-orgd5d682f">
<p>
We thank the Stan Development Team for giving us guidance on how to
create new Stan functions and adding features to Stan's core language
that facilitate building ODE-based models.
</p>

<p>
We also thank Kyle Baron and Hunter Ford for helpful advice on coding
in C++ and using GitHub, Curtis Johnston for reviewing the User
Manual, and Yaming Su for using Torsten and giving us feedback.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf3aa5e7" class="outline-2">
<h2 id="orgf3aa5e7"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Stan is an open source probabilistic programing language designed
primarily to do Bayesian data analysis <a class='org-ref-reference' href="#carpenter17_stan">carpenter17_stan</a>. Several of its
features make it a powerful tool to specify and fit complex
models. Notably, its language is extremely flexible and its No U-Turn
Sampler (NUTS), an adaptative Hamiltonian Monte Carlo algorithm, has
proven more efficient than commonly used Monte Carlo Markov Chains
(MCMC) samplers for complex high dimensional problems <a class='org-ref-reference' href="#hoffman_no-u-turn_2011">hoffman_no-u-turn_2011</a>. Our
goal is to harness these innovative features and make Stan a better
software for pharmacometrics modeling. Our efforts are twofold:
</p>
<ol class="org-ol">
<li>We contribute to the development of new mathematical tools, such as functions that support differential equations based models, and implement them directly into Stan's core language.</li>
<li>We develop Torsten, an extension with specialized pharmacometrics functions.</li>
</ol>

<p>
Throughout the process, we work very closely with the Stan Development
Team. We have benefited immensely from their mentorship, advice, and
feedback. Just like Stan, Torsten is an open source project that
fosters collaborative work. Interested in contributing? Shoot us an
e-mail and we will help you help us(<a href="mailto:billg@metrumrg.com">billg@metrumrg.com</a>)!
</p>

<p>
Torsten is licensed under the BSD 3-clause license.
</p>
</div>

<div id="outline-container-org6bffbf7" class="outline-3">
<h3 id="org6bffbf7"><span class="section-number-3">1.1</span> Installing Torsten</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Installation files are available on GitHub
</p>

<ul class="org-ul">
<li><a href="https://github.com/metrumresearchgroup/Torsten">https://github.com/metrumresearchgroup/Torsten</a></li>
</ul>

<p>
We are working with Stan development team to create a
system to add and share Stan packages. In the mean time,
the current repo contains forked version of Stan with
Torsten. The latest version of Torsten (v0.84) is
compatible with Stan v2.17.1. Torsten is agnostic to which
Stan interface you use. Here we provide command line and R
interfaces.
</p>

<p>
First, download the project. The root path of the project is
your <code>torsten_path</code>. Set the envionment variable
<code class="src src-sh">TORSTEN_PATH</code>
to <code>torsten_path</code>. In bash this is 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">TORSTEN_PATH</span>=torsten_path
</pre>
</div>
</div>

<div id="outline-container-org1c075bb" class="outline-4">
<h4 id="org1c075bb"><span class="section-number-4">1.1.1</span> Command line version</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
There is no need to install command line version. To
build a Stan model with <code>model_name</code> in <code>model_path</code>
using command line, in <code>torsten_path/cmdstan</code>, do
</p>
<div class="org-src-container">
<pre class="src src-sh">make model_path/model_name
</pre>
</div>
</div>
</div>

<div id="outline-container-org4234252" class="outline-4">
<h4 id="org4234252"><span class="section-number-4">1.1.2</span> R version</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
The R version is based on <a href="https://cran.r-project.org/web/packages/rstan/index.html">rstan</a>, the Stan's interface for
R. To install R version of Torsten, at <code>torsten_path</code>, in R
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2; font-weight: bold;">source</span>(<span style="color: #2aa198;">'install.R'</span>)
</pre>
</div>

<p>
Please ensure the R toolchain includes a C++ compiler with
C++11 support. In particular, R 3.3.0 and later is
recommended as it contains toolchain based on gcc 4.9.3. On
Windows platform, such a toolchain can be found in Rtools33 and later.
</p>

<p>
Please ensure CXXFLAGS in .R/Makevars constains flag
-std=c++11. 
</p>

<p>
For more information of installation troubleshooting,
please consult <a href="https://github.com/stan-dev/rstan/wiki">rstan wiki</a>.
</p>
</div>
</div>
</div>


<div id="outline-container-org5a0818b" class="outline-3">
<h3 id="org5a0818b"><span class="section-number-3">1.2</span> Overview</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Torsten is a collection of Stan functions to facilitate analysis of
pharmacometric data using Stan. The current version
includes:
</p>
<ul class="org-ul">
<li>Specific linear compartment models:
<ul class="org-ul">
<li>One compartment model with first order absorption.</li>
<li>Two compartment model with elimination from and first order absorption into central compartment</li>
</ul></li>
<li>General linear compartment model described by a system of first-order \underline{linear} Ordinary Differential Equations (ODEs).</li>
<li>General compartment model described by a system of first order ODEs.</li>
<li>Mix compartment model with PK forcing function described by a linear one or two compartment model.</li>
</ul>

<p>
The models and data format are based on
NONMEM\textregistered{}<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>/NMTRAN/PREDPP
conventions including:
</p>
<ul class="org-ul">
<li>Recursive calculation of model predictions
<ul class="org-ul">
<li>This permits piecewise constant covariate values</li>
</ul></li>
<li>Bolus or constant rate inputs into any compartment</li>
<li>Handles single dose and multiple dose histories</li>
<li>Handles steady state dosing histories
<ul class="org-ul">
<li>Note: The infusion time must be shorter than the inter-dose interval.</li>
</ul></li>
<li>Implemented NMTRAN data items include: TIME, EVID, CMT, AMT, RATE, ADDL, II, SS</li>
</ul>

<p>
In general, all real variables may be passed as Stan parameters. A
few exceptions apply /to functions which use a numerical
integrator/(i.e. the general and the mix compartment
models). The below listed cases present technical difficulties, which we expect to
overcome in Torsten's next release:
</p>
<ul class="org-ul">
<li>The RATE and TIME arguments must be fixed</li>
<li>In the case of a multiple truncated infusion rate dosing regimen:
<ul class="org-ul">
<li>The bioavailability (F) and the amount (AMT) must be fixed.</li>
</ul></li>
</ul>

<p>
This library provides Stan language functions that calculate amounts
in each compartment, given an event schedule and an ODE system.
</p>
</div>
</div>

<div id="outline-container-orgd3ee97f" class="outline-3">
<h3 id="orgd3ee97f"><span class="section-number-3">1.3</span> Implementation details</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>Stan version 2.17.1</li>
<li>All functions are programmed in C++ and are compatible
with the Stan math automatic differentiation library <a class='org-ref-reference' href="#carpenter15_stan_math_librar">carpenter15_stan_math_librar</a></li>
<li>One and two compartment models: hand-coded analytical solutions</li>
<li>General linear compartment models with semi-analytical solutions using the built-in matrix exponential function</li>
<li>General compartment models with numerical solutions using built-in ODE integrators in Stan. The tuning parameters of the solver are adjustable. The steady state solution is calculated using a numerical algebraic solver.</li>
<li>Mix compartment model: the PK forcing function is solved
analytically and the forced ODE system is solved
numerically.</li>
</ul>
</div>
</div>

<div id="outline-container-orge6ae963" class="outline-3">
<h3 id="orge6ae963"><span class="section-number-3">1.4</span> Development plans</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Our current plans for future development of Torsten include the
following:
</p>
<ul class="org-ul">
<li>Build a system to easily share packages of Stan functions
(written in C++ or in the Stan language)</li>
<li>Allow numerical methods to handle RATE, AMT, TIME, and the
bioavailability fraction (F) as parameters in all cases.</li>
<li>Optimize Matrix exponential functions
<ul class="org-ul">
<li>Function for the action of Matrix Exponential on a vector</li>
<li>Hand-coded gradients</li>
<li>Special algorithm for matrices with special properties</li>
</ul></li>
<li>Fix issue that arises when computing the adjoint of the lag time
parameter (in a dosing compartment) evaluated at \(t_{\text{lag}} = 0\).</li>
<li>Extend formal tests
<ul class="org-ul">
<li>We want more C++ Google unit tests to address cases users may
encounter</li>
<li>Comparison with simulations from the R package
<i>mrgsolve</i> and the software NONMEM\textregistered{}</li>
<li>Recruit non-developer users to conduct beta testing</li>
</ul></li>
</ul>
</div>
</div>


<div id="outline-container-org1f7c8e5" class="outline-3">
<h3 id="org1f7c8e5"><span class="section-number-3">1.5</span> Updates since Torsten 0.83</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>Torsten is now up to date with Stan version 2.17.1.</li>
<li>Add piecewise linear interpolation function.</li>
<li>Add univariate integral functions.</li>
<li>Minor revisions to User Manual.</li>
</ul>
</div>
</div>
</div>




<div id="outline-container-org1b50fb3" class="outline-2">
<h2 id="org1b50fb3"><span class="section-number-2">2</span> Using Torsten</h2>
<div class="outline-text-2" id="text-2">
<p>
The reader should have a basic understanding of how Stan works before
reading this chapter. There are excellent resources online to get
started with Stan
</p>

<ul class="org-ul">
<li><a href="http://mc-stan.org/documentation">http://mc-stan.org/documentation</a></li>
</ul>


<p>
In this section we go through the different functions Torsten adds to
Stan. It will be helpful to apply these functions to a simple
example. We have uploaded code and data on
</p>

<ul class="org-ul">
<li><a href="https://github.com/metrumresearchgroup/example-models">https://github.com/metrumresearchgroup/example-models</a></li>
</ul>

<p>
We use the following example to demonstrate use of several functions in the Torsten library.
</p>
</div>
<div id="outline-container-org96da5cf" class="outline-4">
<h4 id="2cptmodel"><a id="org96da5cf"></a>Two compartment model</h4>
<div class="outline-text-4" id="text-2cptmodel">
<p>
We model drug absorption in a single patient and simulate plasma drug concentrations:
</p>

<ul class="org-ul">
<li>Multiple Doses: 1250 mg, every 12 hours, for a total of 15 doses</li>
<li>PK: plasma concentrations of parent drug (\(c\))</li>
<li>PK measured at 0.083, 0.167, 0.25, 0.5, 0.75, 1, 1.5, 2, 4, 6,
8, 10 and 12 hours after 1st, 2nd, and 15th dose. In addition, the
PK is measured every 12 hours throughout the trial.</li>
</ul>

<p>
The plasma concentration (\(c\)) are simulated according to the following equations:
</p>
\begin{eqnarray*}
  \log\left(c\right) &\sim& N\left(\log\left(\widehat{c}\right),\sigma^2\right) \\
  \widehat{c} &=& f_{2cpt}\left(t, CL, Q, V_2, V_3, k_a\right) \\
  \left(CL, Q, V_2, V_3, ka\right) &=& 
                                       \left(5\ {\rm L/h}, 8\  {\rm L/h}, 20\  {\rm L},  70\ {\rm L}, 1.2\ {\rm h^{-1}} \right) \\
  \sigma^2 &=& 0.01
\end{eqnarray*}
<p>
and the drug concentration is given by \(c = y_2/V_2\).
</p>

<p>
where the mass of drug in the central compartment (\(y_2\)) is obtained
by solving the system of ordinary differential equations (ODEs):
</p>
\begin{align*}
  y_1' &= -k_a y_1 \\
  y_2' &= k_a y_1 - \left(\frac{CL}{V_2} + \frac{Q}{V_2}\right) y_2 +  \frac{Q}{V_3}  y_3  \\ 
  y_3' &= \frac{Q}{V_2} y_2 - \frac{Q}{V_3} y_3
\end{align*}

<p>
The data are generated using the R package <code>mrgsolve</code> <a class='org-ref-reference' href="#Baron000">Baron000</a>. 
</p>
</div>
</div>


<div id="outline-container-orgea67120" class="outline-3">
<h3 id="orgea67120"><span class="section-number-3">2.1</span> One Compartment Model</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span>[] <span style="color: #268bd2; font-weight: bold;">=</span> PKModelOneCpt(<span style="color: #b58900;">real</span>[] time, <span style="color: #b58900;">real</span>[] amt, <span style="color: #b58900;">real</span>[] ate,
                       <span style="color: #b58900;">real</span>[] ii, <span style="color: #b58900;">int</span>[] evid, <span style="color: #b58900;">int</span>[] cmt,
                       <span style="color: #b58900;">real</span>[] addl, <span style="color: #b58900;">int</span>[] ss, <span style="color: #b58900;">real</span>[] theta,
                       <span style="color: #b58900;">real</span>[] biovar, <span style="color: #b58900;">real</span>[] tlag)
</pre>
</div>

<p>
Parameters in <code>theta</code> : \(CL\), \(V_2\), \(k_a\).
</p>

<p>
The event arguments. <code>time</code>, <code>amt</code>, <code>rate</code>, <code>ii</code>, <code>evid</code>, <code>cmt</code>, <code>addl</code>, and
<code>ss</code>, describe the event schedule of the clinical
trial. All arrays have the same length, which
corresponds to the number of events.
</p>

<p>
The model arguments, <code>theta</code> contains the ODE
parameters, <code>biovar</code> the bioavailability fraction in each
compartment, and <code>tlag</code> the
lag time in each compartment. The model arguments may be either one
or two dimensional arrays. If they are one dimensional arrays, the
parameters are constant for all events. If they are two dimensional
arrays then each row contains the parameters for the interval
<code>[ time[i-1], time[i] ]</code>. The number of rows should equal the
number of events.
</p>

<p>
Setting \(ka\) to 0 eliminates the first-order absorption.
</p>


<div id="orgfdd3cdb" class="figure">
<p><img src="./graphics/cptModels.png" alt="cptModels.png" />
</p>
<p><span class="figure-number">Figure 1: </span>One and two compartment models with first order absorption implemented in Torsten.</p>
</div>
</div>
</div>

<div id="outline-container-org5910d51" class="outline-3">
<h3 id="org5910d51"><span class="section-number-3">2.2</span> Two Compartment Model</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span>[] <span style="color: #268bd2; font-weight: bold;">=</span> PKModelTwoCpt(<span style="color: #b58900;">real</span>[] time, <span style="color: #b58900;">real</span>[] amt, <span style="color: #b58900;">real</span>[] ate,
                       <span style="color: #b58900;">real</span>[] ii, <span style="color: #b58900;">int</span>[] evid, <span style="color: #b58900;">int</span>[] cmt,
                       <span style="color: #b58900;">real</span>[] addl, <span style="color: #b58900;">int</span>[] ss, <span style="color: #b58900;">real</span>[] theta,
                       <span style="color: #b58900;">real</span>[] biovar, <span style="color: #b58900;">real</span>[] tlag)
</pre>
</div>

<p>
Parameters in <code>theta</code> : \(CL\), \(Q\), \(V_2\), \(V_3\), \(k_a\)
</p>

<p>
See section <a href="#org728b6a8">1</a> for function description.
</p>

<p>
Code example below shows Stan example of using
<code>TwoCptModel</code> to fit <a href="#2cptmodel">Two compartment model</a>. Three MCMC chains of 2000 iterations were simulated. The first
1000 iteration of each chain were discarded. Thus 1000 MCMC samples
per chain were used for the subsequent analyses.
</p>

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">data</span>{
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nt</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of events</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nObs</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of observation</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">iObs</span>[nObs];  <span style="color: #586e75;">// </span><span style="color: #586e75;">index of observation</span>

  <span style="color: #586e75;">// </span><span style="color: #586e75;">NONMEM data</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">cmt</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">evid</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">addl</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">ss</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">amt</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">time</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">rate</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">ii</span>[nt];

  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cObs</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">observed concentration (Dependent Variable)</span>
}

<span style="color: #859900; font-weight: bold;">transformed data</span>{
  <span style="color: #b58900;">vector</span>[nObs] logCObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(cObs);
  <span style="color: #b58900;">int</span> nTheta <span style="color: #268bd2; font-weight: bold;">=</span> 5;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of ODE parameters in Two Compartment Model</span>
  <span style="color: #b58900;">int</span> nCmt <span style="color: #268bd2; font-weight: bold;">=</span> 3;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of compartments in model</span>

  <span style="color: #586e75;">// </span><span style="color: #586e75;">Since we're not trying to evaluate the bio-variability (F) and </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">the lag times, we declare them as data.</span>
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">biovar</span>[nCmt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">tlag</span>[nCmt];

  biovar[1] <span style="color: #268bd2; font-weight: bold;">=</span> 1;
  biovar[2] <span style="color: #268bd2; font-weight: bold;">=</span> 1;
  biovar[3] <span style="color: #268bd2; font-weight: bold;">=</span> 1;

  tlag[1] <span style="color: #268bd2; font-weight: bold;">=</span> 0;
  tlag[2] <span style="color: #268bd2; font-weight: bold;">=</span> 0;
  tlag[3] <span style="color: #268bd2; font-weight: bold;">=</span> 0;

}

<span style="color: #859900; font-weight: bold;">parameters</span>{
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CL</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">Q</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V1</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V2</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ka</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>;

}

<span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">theta</span>[nTheta];  <span style="color: #586e75;">// </span><span style="color: #586e75;">ODE parameters</span>
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt] <span style="color: #268bd2;">cHat</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cHatObs</span>;
  <span style="color: #b58900;">matrix</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt, nCmt] <span style="color: #268bd2;">x</span>; 

  theta[1] <span style="color: #268bd2; font-weight: bold;">=</span> CL;
  theta[2] <span style="color: #268bd2; font-weight: bold;">=</span> Q;
  theta[3] <span style="color: #268bd2; font-weight: bold;">=</span> V1;
  theta[4] <span style="color: #268bd2; font-weight: bold;">=</span> V2;
  theta[5] <span style="color: #268bd2; font-weight: bold;">=</span> ka;

  <span style="color: #586e75;">// </span><span style="color: #586e75;">PKModelTwoCpt takes in the NONMEM data, followed by the parameter</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">arrays abd returns a matrix with the predicted amount in each </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">compartment at each event.</span>
  x <span style="color: #268bd2; font-weight: bold;">=</span> PKModelTwoCpt(time, amt, rate, ii, evid, cmt, addl, ss,
                   theta, biovar, tlag);

  cHat <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">col</span>(x, 2) ./ V1; <span style="color: #586e75;">// </span><span style="color: #586e75;">we're interested in the amount in the second compartment </span>

  cHatObs <span style="color: #268bd2; font-weight: bold;">=</span> cHat[iObs]; <span style="color: #586e75;">// </span><span style="color: #586e75;">predictions for observed data recors</span>
</pre>
</div>

<p>
The MCMC history plots(Figure <a href="#org82e872f">2</a>)
suggest that the 3 chains have converged to common distributions for
all of the key model parameters. The fit to the plasma concentration
data (Figure <a href="#org8af1b47">5</a>) are in close agreement with the
data, which is not surprising since the fitted model is identical to
the one used to simulate the data. Similarly the parameter estimates
summarized in Table <a href="#orgb9f0311">1</a> and Figure <a href="#org4d95bed">4</a>
are consistent with the values used for simulation.
</p>

<table id="orgb9f0311" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Summary of the MCMC simulations of the marginal posterior distribu- tions of the model parameters</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-right">mean</th>
<th scope="col" class="org-right">se<sub>mean</sub></th>
<th scope="col" class="org-right">sd</th>
<th scope="col" class="org-right">2.5%</th>
<th scope="col" class="org-right">25%</th>
<th scope="col" class="org-right">50%</th>
<th scope="col" class="org-right">75%</th>
<th scope="col" class="org-right">97.5%</th>
<th scope="col" class="org-right">n<sub>eff</sub></th>
<th scope="col" class="org-right">Rhat</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">CL</td>
<td class="org-right">4.823</td>
<td class="org-right">0.002</td>
<td class="org-right">0.092</td>
<td class="org-right">4.647</td>
<td class="org-right">4.762</td>
<td class="org-right">4.823</td>
<td class="org-right">4.883</td>
<td class="org-right">5.012</td>
<td class="org-right">2392.155</td>
<td class="org-right">1.00</td>
</tr>

<tr>
<td class="org-left">Q</td>
<td class="org-right">7.596</td>
<td class="org-right">0.013</td>
<td class="org-right">0.586</td>
<td class="org-right">6.479</td>
<td class="org-right">7.201</td>
<td class="org-right">7.594</td>
<td class="org-right">7.977</td>
<td class="org-right">8.785</td>
<td class="org-right">1923.939</td>
<td class="org-right">1.00</td>
</tr>

<tr>
<td class="org-left">V1</td>
<td class="org-right">21.073</td>
<td class="org-right">0.069</td>
<td class="org-right">2.573</td>
<td class="org-right">16.017</td>
<td class="org-right">19.352</td>
<td class="org-right">21.046</td>
<td class="org-right">22.817</td>
<td class="org-right">26.097</td>
<td class="org-right">1385.883</td>
<td class="org-right">1.00</td>
</tr>

<tr>
<td class="org-left">V2</td>
<td class="org-right">76.365</td>
<td class="org-right">0.105</td>
<td class="org-right">5.611</td>
<td class="org-right">65.805</td>
<td class="org-right">72.623</td>
<td class="org-right">76.172</td>
<td class="org-right">79.916</td>
<td class="org-right">87.971</td>
<td class="org-right">2862.184</td>
<td class="org-right">1.00</td>
</tr>

<tr>
<td class="org-left">ka</td>
<td class="org-right">1.231</td>
<td class="org-right">0.004</td>
<td class="org-right">0.177</td>
<td class="org-right">0.907</td>
<td class="org-right">1.107</td>
<td class="org-right">1.221</td>
<td class="org-right">1.344</td>
<td class="org-right">1.599</td>
<td class="org-right">1581.825</td>
<td class="org-right">1.00</td>
</tr>

<tr>
<td class="org-left">sigma</td>
<td class="org-right">0.109</td>
<td class="org-right">0.000</td>
<td class="org-right">0.012</td>
<td class="org-right">0.089</td>
<td class="org-right">0.100</td>
<td class="org-right">0.108</td>
<td class="org-right">0.116</td>
<td class="org-right">0.134</td>
<td class="org-right">2560.112</td>
<td class="org-right">1.00</td>
</tr>
</tbody>
</table>


<p>
<a href="../Torsten/example-models/R/deliv/figure/TwoCptModel/TwoCptModelPlots001.pdf">../example-models/R/deliv/figure/TwoCptModel/TwoCptModelPlots001.pdf</a>
</p>

<p>
<a href="../Torsten/example-models/R/deliv/figure/TwoCptModel/TwoCptModelPlots002.pdf">../example-models/R/deliv/figure/TwoCptModel/TwoCptModelPlots002.pdf</a>
</p>

<p>
<a href="../Torsten/example-models/R/deliv/figure/TwoCptModel/TwoCptModelPlots003.pdf">../example-models/R/deliv/figure/TwoCptModel/TwoCptModelPlots003.pdf</a>
</p>

<p>
<a href="../Torsten/example-models/R/deliv/figure/TwoCptModel/TwoCptModelPlots006.pdf">../example-models/R/deliv/figure/TwoCptModel/TwoCptModelPlots006.pdf</a>
</p>
</div>
</div>


<div id="outline-container-org97029f9" class="outline-3">
<h3 id="org97029f9"><span class="section-number-3">2.3</span> General Linear ODE Model Function</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span>[] <span style="color: #268bd2; font-weight: bold;">=</span> linOdeModel(<span style="color: #b58900;">real</span>[] time, <span style="color: #b58900;">real</span>[] amt, <span style="color: #b58900;">real</span>[] rate,
                     <span style="color: #b58900;">real</span>[] ii, <span style="color: #b58900;">int</span>[] evid, <span style="color: #b58900;">int</span>[] cmt,
                     <span style="color: #b58900;">real</span>[] addl, <span style="color: #b58900;">int</span>[] ss,
                     <span style="color: #b58900;">matrix</span> K, <span style="color: #b58900;">real</span>[] biovar, <span style="color: #b58900;">real</span>[] tlag)
</pre>
</div>
<p>
A general linear ODE model refers to a model that may be described in
terms of a system of first order linear differential equations with
(piecewise) constant coefficients, i.e., a differential equation of
the form:
</p>
\begin{equation}
y^\prime\left(t\right) = Ky\left(t\right)
\end{equation}
<p>
where \(K\) is a matrix. For example \(K\) for a two compartment model
(equation \eqref{eq:TwoCpt}) with first order absorption is:
</p>
\begin{equation}
  K = \left[\begin{array}{ccc}
              -k_a & 0 & 0 \\
              k_a & -\left(k_{10} + k_{12}\right) & k_{21} \\
              0 & k_{12} & -k_{21}
            \end{array}\right]
\end{equation}
<p>
where \(k_{10}=CL/V_2\), \(k_{12}=Q/V_2\), and \(k_{21}=Q/V_3\).
</p>

<p>
System parameters is in <code>K</code>, with <code>K</code> being the constant rate
matrix is the same for all events or an array of constant rate matrices. The length of the array is
the number of events and each element corresponds to the matrix at
the interval <code>[ time[i-1], time[i] ]</code>.
Note that <code>K</code> contains all the ODE parameters, so we no
longer need <code>theta</code>.
</p>

<p>
The following Stan example illustrate
the use of General linear model for fitting a two compartment model
with first order absorption.
</p>

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #586e75;">// </span><span style="color: #586e75;">LinTwoCptModelExample.stan</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">Run two compartment model using matrix exponential solution</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">Heavily anotated to help new users</span>

<span style="color: #859900; font-weight: bold;">data</span>{
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nt</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of events</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nObs</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of observations</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">iObs</span>[nObs];  <span style="color: #586e75;">// </span><span style="color: #586e75;">index of observation</span>

  <span style="color: #586e75;">// </span><span style="color: #586e75;">NONMEM data</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">cmt</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">evid</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">addl</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">ss</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">amt</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">time</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">rate</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">ii</span>[nt];

  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cObs</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">observed concentration (dependent variable)</span>
}

<span style="color: #859900; font-weight: bold;">transformed data</span>{
  <span style="color: #b58900;">vector</span>[nObs] logCObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(cObs);
  <span style="color: #b58900;">int</span> nCmt <span style="color: #268bd2; font-weight: bold;">=</span> 3;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">biovar</span>[nCmt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">tlag</span>[nCmt];

  <span style="color: #859900; font-weight: bold;">for</span> (i <span style="color: #859900; font-weight: bold;">in</span> 1:nCmt) {
    biovar[i] <span style="color: #268bd2; font-weight: bold;">=</span> 1;
    tlag[i] <span style="color: #268bd2; font-weight: bold;">=</span> 0;
  }
}

<span style="color: #859900; font-weight: bold;">parameters</span>{
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CL</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">Q</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V1</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V2</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ka</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>;

}

<span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">matrix</span>[3, 3] <span style="color: #268bd2;">K</span>;
  <span style="color: #b58900;">real</span> k10 <span style="color: #268bd2; font-weight: bold;">=</span> CL / V1;
  <span style="color: #b58900;">real</span> k12 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V1;
  <span style="color: #b58900;">real</span> k21 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V2;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt] <span style="color: #268bd2;">cHat</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cHatObs</span>;
  <span style="color: #b58900;">matrix</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt, 3] <span style="color: #268bd2;">x</span>;

  K <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">rep_matrix</span>(0, 3, 3);

  K[1, 1] <span style="color: #268bd2; font-weight: bold;">=</span> -ka;
  K[2, 1] <span style="color: #268bd2; font-weight: bold;">=</span> ka;
  K[2, 2] <span style="color: #268bd2; font-weight: bold;">=</span> -(k10 + k12);
  K[2, 3] <span style="color: #268bd2; font-weight: bold;">=</span> k21;
  K[3, 2] <span style="color: #268bd2; font-weight: bold;">=</span> k12;
  K[3, 3] <span style="color: #268bd2; font-weight: bold;">=</span> -k21;

  <span style="color: #586e75;">// </span><span style="color: #586e75;">linModel takes in the constant rate matrix, the object theta which</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">contains the biovariability fraction and the lag time of each compartment,</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">and the NONMEM data.</span>
  x <span style="color: #268bd2; font-weight: bold;">=</span> linOdeModel(time, amt, rate, ii, evid, cmt, addl, ss,
                  K, biovar, tlag);
</pre>
</div>
</div>
</div>

<div id="outline-container-orga4be51d" class="outline-3">
<h3 id="orga4be51d"><span class="section-number-3">2.4</span> General ODE Model Function</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span>[] <span style="color: #268bd2;">model_name</span>(ODE_system, <span style="color: #b58900;">int</span> nCmt,
                  <span style="color: #b58900;">real</span>[] time, <span style="color: #b58900;">real</span>[] amt, <span style="color: #b58900;">real</span>[] rate, <span style="color: #b58900;">real</span>[] ii,
                  <span style="color: #b58900;">int</span>[] evid, <span style="color: #b58900;">int</span>[] cmt, <span style="color: #b58900;">real</span>[] addl, <span style="color: #b58900;">int</span>[] ss,
                  <span style="color: #b58900;">real</span>[] theta, <span style="color: #b58900;">real</span>[] biovar, <span style="color: #b58900;">real</span>[] tlag,                      
                  <span style="color: #b58900;">real</span> rel_tol, <span style="color: #b58900;">real</span> abs_tol, <span style="color: #b58900;">int</span> max_step)
</pre>
</div>

<p>
Torsten may be used to fit models described by a system of
user-specified first-order ODEs, i.e., differential equations of the form:
</p>
\begin{equation*}
y'(t) = f(t, y(t))
\end{equation*}
<p>
In the case where the rate vector \(R\) is non-zero, this equation becomes:
</p>
\begin{equation*}
y'(t) = f(t, y(t)) + R
\end{equation*}

<p>
<code>ODE_system</code> specifies \(f(t, y(t))\), which the user
defines inside the <code>functions</code> block (see section 19.2 of the
Stan reference manual for details and Figure~\ref{GenTwoCptModelCode}
for an example). The user does NOT include the rates in their
definition of \(f\). Torsten automatically corrects the derivatives when
the rates are non-zero.
</p>

<p>
<code>nCmt</code> is the number of compartments (or, equivalently, the
number of ODEs) in the model. <code>rel_tol</code>, <code>abs_tol</code>,
and <code>max_step</code> are tuning parameters for the ODE integrator:
respectively the relative tolerance, the absolute tolerance, and the
maximum number of steps.
</p>

<p>
The options for <code>model_name</code> are:
</p>
<ul class="org-ul">
<li><code>generalOdeModel_rk45</code></li>
<li><code>generalOdeModel_bdf</code></li>
</ul>

<p>
They respectively call the built-in Runge-Kutta 4th/5th order (rk45)
integrator, recommended for non-stiff ODEs, and the Backward
Differentiation (BDF) integrator, recommended for stiff ODEs. Which
value to use for the tuning parameters depends on the integrator and
the specifics of the ODE system. Reducing the tolerance parameters and
increasing the number of steps make for a more robust integrator but
can significantly slow down the algorithm. The following can be used
as a starting point: 
</p>
<ul class="org-ul">
<li><code>rel_tol = 1e-6</code></li>
<li><code>abs_tol = 1e-6</code></li>
<li><code>max_step = 1e+6</code></li>
</ul>
<p>
for rk45 integrator and
</p>
<ul class="org-ul">
<li><code>rel_tol = 1e-10</code></li>
<li><code>abs_tol = 1e-10</code></li>
<li><code>max_step = 1e+8</code></li>
</ul>
<p>
for the bdf integrator <sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>.
Users should be prepared to adjust these
values. For additional information, see the Stan User's
Manual <a class='org-ref-reference' href="#stan_team_2017">stan_team_2017</a>.
</p>

<p>
A few notable restrictions apply to :
</p>
<ul class="org-ul">
<li><code>rate</code> and <code>time</code> cannot be passed as parameters.</li>
<li>In the case of a multiple truncated infusion rate dosing regimen:
<ul class="org-ul">
<li>The bioavailability <code>biovar</code>) and the amount <code>amt</code>) cannot be passed as parameters.</li>
</ul></li>
</ul>
<p>
These restrictions also apply to <code>mixOdeCpt_*</code> functions, discussed in the next section.
</p>

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #586e75;">// </span><span style="color: #586e75;">GenTwoCptModelExample.stan</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">Run two compartment model using numerical solution</span>
<span style="color: #586e75;">// </span><span style="color: #586e75;">Heavily anotated to help new users</span>

<span style="color: #859900; font-weight: bold;">functions</span>{

  <span style="color: #586e75;">// </span><span style="color: #586e75;">define ODE system for two compartmnt model</span>
  <span style="color: #b58900;">real</span>[] <span style="color: #268bd2;">twoCptModelODE</span>(<span style="color: #b58900;">real</span> t,
                        <span style="color: #b58900;">real</span>[] x,
                        <span style="color: #b58900;">real</span>[] parms,
                        <span style="color: #b58900;">real</span>[] rate,  <span style="color: #586e75;">// </span><span style="color: #586e75;">in this example, rate is treated as data</span>
                        <span style="color: #b58900;">int</span>[] dummy){

    <span style="color: #586e75;">// </span><span style="color: #586e75;">Parameters</span>
    <span style="color: #b58900;">real</span> CL <span style="color: #268bd2; font-weight: bold;">=</span> parms[1];
    <span style="color: #b58900;">real</span> Q <span style="color: #268bd2; font-weight: bold;">=</span> parms[2];
    <span style="color: #b58900;">real</span> V1 <span style="color: #268bd2; font-weight: bold;">=</span> parms[3];
    <span style="color: #b58900;">real</span> V2 <span style="color: #268bd2; font-weight: bold;">=</span> parms[4];
    <span style="color: #b58900;">real</span> ka <span style="color: #268bd2; font-weight: bold;">=</span> parms[5];

    <span style="color: #586e75;">// </span><span style="color: #586e75;">Re-parametrization</span>
    <span style="color: #b58900;">real</span> k10 <span style="color: #268bd2; font-weight: bold;">=</span> CL / V1;
    <span style="color: #b58900;">real</span> k12 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V1;
    <span style="color: #b58900;">real</span> k21 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V2;

    <span style="color: #586e75;">// </span><span style="color: #586e75;">Return object (derivative)</span>
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">y</span>[3];  <span style="color: #586e75;">// </span><span style="color: #586e75;">1 element per compartment of</span>
                <span style="color: #586e75;">// </span><span style="color: #586e75;">the model</span>

    <span style="color: #586e75;">// </span><span style="color: #586e75;">PK component of the ODE system</span>
    y[1] <span style="color: #268bd2; font-weight: bold;">=</span> -ka*x[1];
    y[2] <span style="color: #268bd2; font-weight: bold;">=</span> ka*x[1] - (k10 + k12)*x[2] + k21*x[3];
    y[3] <span style="color: #268bd2; font-weight: bold;">=</span> k12*x[2] - k21*x[3];

    <span style="color: #859900; font-weight: bold;">return</span> y;
  }

}
<span style="color: #859900; font-weight: bold;">data</span>{
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nt</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of events</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nObs</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of observations</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">iObs</span>[nObs];  <span style="color: #586e75;">// </span><span style="color: #586e75;">index of observation</span>

  <span style="color: #586e75;">// </span><span style="color: #586e75;">NONMEM data</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">cmt</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">evid</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">addl</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">ss</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">amt</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">time</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">rate</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">ii</span>[nt];

  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cObs</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">observed concentration (dependent variable)</span>
}

<span style="color: #859900; font-weight: bold;">transformed data</span>{
  <span style="color: #b58900;">vector</span>[nObs] logCObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(cObs);
  <span style="color: #b58900;">int</span> nTheta <span style="color: #268bd2; font-weight: bold;">=</span> 5;   <span style="color: #586e75;">// </span><span style="color: #586e75;">number of parameters</span>
  <span style="color: #b58900;">int</span> nCmt <span style="color: #268bd2; font-weight: bold;">=</span> 3;   <span style="color: #586e75;">// </span><span style="color: #586e75;">number of compartments</span>
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">biovar</span>[nCmt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">tlag</span>[nCmt];

  <span style="color: #859900; font-weight: bold;">for</span> (i <span style="color: #859900; font-weight: bold;">in</span> 1:nCmt) {
    biovar[i] <span style="color: #268bd2; font-weight: bold;">=</span> 1;
    tlag[i] <span style="color: #268bd2; font-weight: bold;">=</span> 0;
  }
}

<span style="color: #859900; font-weight: bold;">parameters</span>{
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CL</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">Q</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V1</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V2</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ka</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>;
}

<span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">theta</span>[nTheta];
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt] <span style="color: #268bd2;">cHat</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cHatObs</span>;
  <span style="color: #b58900;">matrix</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt, 3] <span style="color: #268bd2;">x</span>; 

  theta[1] <span style="color: #268bd2; font-weight: bold;">=</span> CL;
  theta[2] <span style="color: #268bd2; font-weight: bold;">=</span> Q;
  theta[3] <span style="color: #268bd2; font-weight: bold;">=</span> V1;
  theta[4] <span style="color: #268bd2; font-weight: bold;">=</span> V2;
  theta[5] <span style="color: #268bd2; font-weight: bold;">=</span> ka;

  <span style="color: #586e75;">// </span><span style="color: #586e75;">generalCptModel takes in the ODE system, the number of compartment </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">(here we have a two compartment model with first order absorption, so</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">three compartments), the parameters matrix, the NONEM data, and the tuning</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">parameters (relative tolerance, absolute tolerance, and maximum number of steps)</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">of the ODE integrator. The user can choose between the bdf and the rk45 integrator.</span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">Returns a matrix with the predicted amount in each compartment </span>
  <span style="color: #586e75;">// </span><span style="color: #586e75;">at each event.</span>

<span style="color: #586e75;">//  </span><span style="color: #586e75;">x = generalOdeModel_bdf(twoCptModelODE, 3,</span>
<span style="color: #586e75;">//                          </span><span style="color: #586e75;">time, amt, rate, ii, evid, cmt, addl, ss,</span>
<span style="color: #586e75;">//                          </span><span style="color: #586e75;">theta, biovar, tlag,</span>
<span style="color: #586e75;">//                          </span><span style="color: #586e75;">1e-8, 1e-8, 1e8);</span>

   x <span style="color: #268bd2; font-weight: bold;">=</span> generalOdeModel_rk45(twoCptModelODE, 3,
                           time, amt, rate, ii, evid, cmt, addl, ss,
                           theta, biovar, tlag,
                           1e-6, 1e-6, 1e6);

  cHat <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">col</span>(x, 2) ./ V1;

  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObs){
    cHatObs[i] <span style="color: #268bd2; font-weight: bold;">=</span> cHat[iObs[i]];  <span style="color: #586e75;">// </span><span style="color: #586e75;">predictions for observed data records</span>
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org610cb1f" class="outline-3">
<h3 id="org610cb1f"><span class="section-number-3">2.5</span> Mixed ODE Model Function</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span>[] <span style="color: #268bd2;">model_name</span>(reduced_ODE_system, <span style="color: #b58900;">int</span> nOde,
                  <span style="color: #b58900;">real</span>[] time, <span style="color: #b58900;">real</span>[] amt, <span style="color: #b58900;">real</span>[] rate,
                  <span style="color: #b58900;">real</span>[] ii, <span style="color: #b58900;">int</span>[] evid, <span style="color: #b58900;">int</span>[] cmt, <span style="color: #b58900;">real</span>[]
                  addl, <span style="color: #b58900;">int</span>[] ss,
                  <span style="color: #b58900;">real</span>[] theta, <span style="color: #b58900;">real</span>[] biovar, <span style="color: #b58900;">real</span>[] tlag,
                  <span style="color: #b58900;">real</span> rel_tol, <span style="color: #b58900;">real</span> abs_tol, <span style="color: #b58900;">real</span> max_step)
</pre>
</div>

<p>
In certain cases, an ODE system can be divided in two subsystems:
</p>

\begin{align*}
  y_1^\prime &= f_1(t, y_1) \\
  y_2^\prime &= f_2(t, y_1, y_2)
\end{align*}
<p>
where \(y_1\), \(y_2\), \(f_1\), and \(f_2\) are vector-valued functions, and
\(y_1^\prime\) is independent of \(y_2\). This structure arises in PK/PD
models, where \(y_1\) describes a forcing PK function and \(y_2\) the PD
effects. If \(y_1\) has an analytical solution, we can construct a
\textit{mixed solver}, which analytically solves \(y_1\) and numerically
integrates \(y_2\). This approach leads to an appreciable gain in
computational efficiency. In the example of a Friberg-Karlsson
semi-mechanistic model, we observe an average speedup of
\(\sim 47 \pm 18 \%\) when using the mix solver in lieu of the numerical
integrator. Torsten supports the mixed solver for
cases where \(y_1\) solves the ODEs for a One or Two Compartment model
with a first-order absorption.
</p>

<p>
The <code>reduced_ODE_system</code> specifies the system we
numerically solve (\(y_2\) in the above discussion, also called the
<i>reduced system</i> and <code>nOde</code> the number of equations in
the \underline{reduced} system. The function that defines a reduced
system has an almost identical signature to that used for a full
system, but takes one additional argument: \(y_1\), the PKstates,
i.e. solution to the PK ODEs.
</p>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span>[] <span style="color: #268bd2;">reducedODE</span>(<span style="color: #b58900;">real</span> t,  <span style="color: #586e75;">// </span><span style="color: #586e75;">time</span>
                  <span style="color: #b58900;">real</span>[] y,  <span style="color: #586e75;">// </span><span style="color: #586e75;">reduced state</span>
                  <span style="color: #b58900;">real</span>[] y1,  <span style="color: #586e75;">// </span><span style="color: #586e75;">PK states}'</span>
                  <span style="color: #b58900;">real</span>[] theta,  <span style="color: #586e75;">// </span><span style="color: #586e75;">parameters</span>
                  <span style="color: #b58900;">real</span>[] x_r,  <span style="color: #586e75;">// </span><span style="color: #586e75;">data (real)</span>
                  <span style="color: #b58900;">int</span>[] x_int)  <span style="color: #586e75;">// </span><span style="color: #586e75;">data (integer)</span>
</pre>
</div>

<p>
The options for <code>modelName</code> are:
</p>
<ul class="org-ul">
<li><code>mixOde1CptModel_rk45</code></li>
<li><code>mixOde1CptModel_bdf</code></li>
<li><code>mixOde2CptModel_rk45</code></li>
<li><code>mixOde2CptModel_bdf</code></li>
</ul>

<p>
These four functions correspond to all the permutations we can obtain
when using a forcing One or Two Compartment function, and the
Runge-Kutta 4th/5th order (rk45) or Backward Differentiation (BDF)
integration method. The mixed ODE functions can be used to compute the
steady state solutions supported by the general ODE model functions.
</p>

<p>
Restrictions regarding which arguments may be passed as parameters for
<code>generalOdeModel_*</code> also apply to
<code>mixOdeCptModel_*</code>.
</p>

<p>
We cannot apply the mixed solver to the Two Compartment example we
have been using so far. Instead, we will consider the model which
motivated the implementation of the method in the first place.
</p>
</div>
</div>

<div id="outline-container-org38c3417" class="outline-3">
<h3 id="org38c3417"><span class="section-number-3">2.6</span> Friberg-Karlsson Semi-Mechanistic Model</h3>
<div class="outline-text-3" id="text-2-6">
<p>
In this second example, we add to our two Compartment model a PD
effect, described by a system of nonlinear ODEs <a class='org-ref-reference' href="#friberg_mechanistic_2003">friberg_mechanistic_2003</a>.
</p>
</div>
<div id="outline-container-orgf4442b8" class="outline-4">
<h4 id="fkmodel"><a id="orgf4442b8"></a>Friberg-Karlsson Model</h4>
<div class="outline-text-4" id="text-fkmodel">
<p>
Neutropenia is observed in patients receiving an ME-2 drug. Our goal
is to model the relation between neutrophil counts and drug
exposure. Using a feedback mechanism, the body maintains the number of
neutrophils at a baseline value (Figure~\ref{FK}). While in the
patient's blood, the drug impedes the production of neutrophils. As a
result, the neutrophil count goes down. After the drug clears out, the
feedback mechanism kicks in and brings the neutrophil count back to
baseline.
</p>

\begin{align}
  \log(ANC_i) \sim& N(\log(Circ), \sigma^2_{ANC})  \\
  Circ =& f_{FK}(MTT, Circ_{0}, \alpha, \gamma, c)  \\
  (MTT, Circ_{0}, \alpha, \gamma, ktr) =& (125, 5.0, 3 \times 10^{-4}, 0.17) \\
  \sigma^2_{ANC} =& 0.001
\end{align}
<p>
where \(c\) is the drug concentration in the blood we get from the Two
Compartment model, and \(Circ\) is obtained by solving the following
system of nonlinear ODEs:
</p>

\begin{eqnarray}
  \begin{aligned}
   y_\mathrm{prol}' &= k_\mathrm{prol} y_\mathrm{prol} (1 - E_\mathrm{drug})\left(\frac{Circ_0}{y_\mathrm{circ}}\right)^\gamma - k_\mathrm{tr}y_\mathrm{prol} \\
   y_\mathrm{trans1}' &= k_\mathrm{tr} y_\mathrm{prol} - k_\mathrm{tr} y_\mathrm{trans1} \\
   y_\mathrm{trans2}' &= k_\mathrm{tr} y_\mathrm{trans1} - k_\mathrm{tr} y_\mathrm{trans2}  \\
   y_\mathrm{trans3}' &= k_\mathrm{tr} y_\mathrm{trans2} - k_\mathrm{tr} y_\mathrm{trans3}  \\
   y_\mathrm{circ}' &= k_\mathrm{tr} y_\mathrm{trans3} - k_\mathrm{tr} y_\mathrm{circ}
   \end{aligned}
   \label{eq:FK}
\end{eqnarray}
<p>
where \(E_{drug}  = \alpha c\).
</p>

<p>
The ODEs specifying the Two Compartment Model
(equation~\ref{eq:TwoCpt}) do not depend on the PD ODEs
(equation~\ref{eq:FK}) and can be solved analytically by Torsten. We
therefore specify our model using a mixed solver function. We do not
expect our system to be stiff and use the Runge-Kutta 4th/5th order
integrator (Figures \ref{FK_reduced} and \ref{FK_mix2}).
</p>

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">functions</span>{
  <span style="color: #b58900;">real</span>[] <span style="color: #268bd2;">FK_ODE</span>(<span style="color: #b58900;">real</span> t,
                <span style="color: #b58900;">real</span>[] y,
                <span style="color: #b58900;">real</span>[] y_pk,
                <span style="color: #b58900;">real</span>[] theta,
                <span style="color: #b58900;">real</span>[] rdummy,
                <span style="color: #b58900;">int</span>[] idummy){
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">PK variables </span><span style="color: #586e75;">*/</span>
    <span style="color: #b58900;">real</span> VC <span style="color: #268bd2; font-weight: bold;">=</span> theta[3];

    <span style="color: #586e75;">/* </span><span style="color: #586e75;">PD variable </span><span style="color: #586e75;">*/</span>
    <span style="color: #b58900;">real</span> mtt      <span style="color: #268bd2; font-weight: bold;">=</span> theta[6];
    <span style="color: #b58900;">real</span> circ0    <span style="color: #268bd2; font-weight: bold;">=</span> theta[7];
    <span style="color: #b58900;">real</span> alpha    <span style="color: #268bd2; font-weight: bold;">=</span> theta[8];
    <span style="color: #b58900;">real</span> gamma    <span style="color: #268bd2; font-weight: bold;">=</span> theta[9];
    <span style="color: #b58900;">real</span> ktr      <span style="color: #268bd2; font-weight: bold;">=</span> 4.0 / mtt;
    <span style="color: #b58900;">real</span> prol     <span style="color: #268bd2; font-weight: bold;">=</span> y[1] + circ0;
    <span style="color: #b58900;">real</span> transit1 <span style="color: #268bd2; font-weight: bold;">=</span> y[2] + circ0;
    <span style="color: #b58900;">real</span> transit2 <span style="color: #268bd2; font-weight: bold;">=</span> y[3] + circ0;
    <span style="color: #b58900;">real</span> transit3 <span style="color: #268bd2; font-weight: bold;">=</span> y[4] + circ0;
    <span style="color: #b58900;">real</span> circ     <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">fmax</span>(<span style="color: #268bd2;">machine_precision</span>(), y[5] + circ0);
    <span style="color: #b58900;">real</span> conc     <span style="color: #268bd2; font-weight: bold;">=</span> y_pk[2] / VC;
    <span style="color: #b58900;">real</span> EDrug    <span style="color: #268bd2; font-weight: bold;">=</span> alpha * conc;

    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">dydt</span>[5];

    dydt[1] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * prol * ((1 - EDrug) * ((circ0 / circ)^gamma) - 1);
    dydt[2] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (prol - transit1);
    dydt[3] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (transit1 - transit2);
    dydt[4] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (transit2 - transit3);
    dydt[5] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (transit3 - circ);

    <span style="color: #859900; font-weight: bold;">return</span> dydt;
  }
}

<span style="color: #859900; font-weight: bold;">data</span>{
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nt</span>;
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nObsPK</span>;
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nObsPD</span>;
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">iObsPK</span>[nObsPK];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">iObsPD</span>[nObsPD];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">amt</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">cmt</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">evid</span>[nt];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">time</span>[nt];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ii</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">addl</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ss</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">rate</span>[nt];
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObsPK] <span style="color: #268bd2;">cObs</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObsPD] <span style="color: #268bd2;">neutObs</span>;

  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">circ0Prior</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">circ0PriorCV</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">mttPrior</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">mttPriorCV</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">gammaPrior</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">gammaPriorCV</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">alphaPrior</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">alphaPriorCV</span>;
}

<span style="color: #859900; font-weight: bold;">transformed data</span>{
  <span style="color: #b58900;">int</span> nOde <span style="color: #268bd2; font-weight: bold;">=</span> 5;
  <span style="color: #b58900;">vector</span>[nObsPK] <span style="color: #268bd2;">logCObs</span>;
  <span style="color: #b58900;">vector</span>[nObsPD] <span style="color: #268bd2;">logNeutObs</span>;
<span style="color: #586e75;">//  </span><span style="color: #586e75;">int idummy[0];</span>
<span style="color: #586e75;">//  </span><span style="color: #586e75;">real rdummy[0];</span>

  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nTheta</span>;
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nIIV</span>;

  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">n</span>;                        <span style="color: #586e75;">/* </span><span style="color: #586e75;">ODE dimension </span><span style="color: #586e75;">*/</span>
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">rtol</span>;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">atol</span>;
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">max_step</span>;

  n <span style="color: #268bd2; font-weight: bold;">=</span> 8;
  rtol <span style="color: #268bd2; font-weight: bold;">=</span> 1e-8;
  atol <span style="color: #268bd2; font-weight: bold;">=</span> 1e-8;
  max_step <span style="color: #268bd2; font-weight: bold;">=</span> 100000;

  logCObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(cObs);
  logNeutObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(neutObs);

  nIIV <span style="color: #268bd2; font-weight: bold;">=</span> 7; <span style="color: #586e75;">// </span><span style="color: #586e75;">parameters with IIV</span>
  nTheta <span style="color: #268bd2; font-weight: bold;">=</span> 9; <span style="color: #586e75;">// </span><span style="color: #586e75;">number of parameters</span>
}

<span style="color: #859900; font-weight: bold;">parameters</span>{

  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CL</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">Q</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">VC</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">VP</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ka</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">mtt</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">circ0</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">alpha</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">gamma</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigmaNeut</span>;

  <span style="color: #586e75;">// </span><span style="color: #586e75;">IIV parameters</span>
  <span style="color: #b58900;">cholesky_factor_corr</span>[nIIV] <span style="color: #268bd2;">L</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nIIV] <span style="color: #268bd2;">omega</span>;
}

<span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">vector</span>[nt] <span style="color: #268bd2;">cHat</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObsPK] <span style="color: #268bd2;">cHatObs</span>;
  <span style="color: #b58900;">vector</span>[nt] <span style="color: #268bd2;">neutHat</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObsPD] <span style="color: #268bd2;">neutHatObs</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">theta</span>[nTheta];
  <span style="color: #b58900;">matrix</span>[nt, nOde + 3] <span style="color: #268bd2;">x</span>;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">biovar</span>[nTheta];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">tlag</span>[nTheta];

  <span style="color: #859900; font-weight: bold;">for</span> (i <span style="color: #859900; font-weight: bold;">in</span> 1:nTheta) {
    biovar[i] <span style="color: #268bd2; font-weight: bold;">=</span> 1.0;
    tlag[i] <span style="color: #268bd2; font-weight: bold;">=</span> 0.0;
  }

  theta[1] <span style="color: #268bd2; font-weight: bold;">=</span> CL;
  theta[2] <span style="color: #268bd2; font-weight: bold;">=</span> Q;
  theta[3] <span style="color: #268bd2; font-weight: bold;">=</span> VC;
  theta[4] <span style="color: #268bd2; font-weight: bold;">=</span> VP;
  theta[5] <span style="color: #268bd2; font-weight: bold;">=</span> ka;
  theta[6] <span style="color: #268bd2; font-weight: bold;">=</span> mtt;
  theta[7] <span style="color: #268bd2; font-weight: bold;">=</span> circ0;
  theta[8] <span style="color: #268bd2; font-weight: bold;">=</span> alpha;
  theta[9] <span style="color: #268bd2; font-weight: bold;">=</span> gamma;

  x <span style="color: #268bd2; font-weight: bold;">=</span> mixOde2CptModel_rk45(FK_ODE, nOde, time, amt, rate, ii, evid, cmt, addl, ss, theta, biovar, tlag, rtol, atol, max_step);

  cHat <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">col</span>(x, 2) / VC;
  neutHat <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">col</span>(x, 8) + circ0;

  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObsPK) cHatObs[i]    <span style="color: #268bd2; font-weight: bold;">=</span> cHat[iObsPK[i]];
  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObsPD) neutHatObs[i] <span style="color: #268bd2; font-weight: bold;">=</span> neutHat[iObsPD[i]];

}

<span style="color: #859900; font-weight: bold;">model</span> {

  <span style="color: #586e75;">// </span><span style="color: #586e75;">Priors</span>
  CL    <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 20);
  Q     <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 20);
  VC    <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 100);
  VP    <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 1000);
  ka    <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 5);
  sigma <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">cauchy</span>(0, 1);

  mtt       <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(mttPrior), mttPriorCV);
  circ0     <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(circ0Prior), circ0PriorCV);
  alpha     <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(alphaPrior), alphaPriorCV);
  gamma     <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(gammaPrior), gammaPriorCV);
  sigmaNeut <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">cauchy</span>(0, 1);

  <span style="color: #586e75;">// </span><span style="color: #586e75;">Parameters for Matt's trick</span>
  L <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lkj_corr_cholesky</span>(1);
  omega <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">cauchy</span>(0, 1);

  <span style="color: #586e75;">// </span><span style="color: #586e75;">observed data likelihood</span>
  logCObs <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(<span style="color: #268bd2;">log</span>(cObs), sigma);
  logNeutObs <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(<span style="color: #268bd2;">log</span>(neutObs), sigmaNeut);
}
</pre>
</div>

<p>
\appendix
\printindex
\backmatter
</p>

<p>
\bibliography{torsten}

</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara">NONMEM\textregistered{} is licensed and distributed by ICON Development Solutions.</div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara">These are the default tuning parameters the integrators. Torsten functions do not have a default values for these parameters. The user must explicitly pass the tuning parameters to <code>generalOdeModel_*()</code> .</div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Yi Zhang</p>
<p class="date">Created: 2018-03-22 Thu 00:01</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
